# ==============================================================================
# [Remote Config] API Gateway Service - Dynamic Configuration
# ì´ íŒŒì¼ì€ GitHubì—ì„œ ê´€ë¦¬ë˜ë©°, ë³€ê²½ ì‹œ ì„œë²„ ì¬ë°°í¬ ì—†ì´ /bus-refreshë¡œ ë°˜ì˜ë©ë‹ˆë‹¤.
# ==============================================================================

# âœ… [Core] í¬íŠ¸ ê°•ì œ ì§€ì • (Local ì„¤ì •ì„ ë®ì–´ì“°ê¸° ìœ„í•¨)
server:
  port: 8000

# 1. Spring Cloud Gateway ë¼ìš°íŒ… & í•„í„°
spring:
  cloud:
    gateway:
      httpclient:
        connect-timeout: 5000
        response-timeout: 5000
      globalcors:
        cors-configurations:
          '[/**]':
            allowedOrigins: "*"
            allowedMethods:
              - GET
              - POST
              - PUT
              - DELETE
              - OPTIONS
            allowedHeaders: "*"
            allowCredentials: false
       
      # ğŸš¦ ë¼ìš°íŒ… ê·œì¹™ ì •ì˜ (ì£¼ì˜: Path ì¡°ê±´ì€ ì½¤ë§ˆ(,)ë¡œ êµ¬ë¶„í•´ì•¼ OR ì¡°ê±´ìœ¼ë¡œ ë™ì‘í•¨)
      routes:
        # (1) Member Service
        - id: member-service
          uri: lb://MEMBER-SERVICE
          predicates:
            - Path=/member-service/**, /api/v1/members/** # âœ… ì½¤ë§ˆë¡œ ì—°ê²° (OR ì¡°ê±´)
          filters:
            - name: CircuitBreaker
              args:
                name: memberCircuitBreaker
                fallbackUri: forward:/fallback/member

        # (2) Catalog Service
        - id: catalog-service
          uri: lb://CATALOG-SERVICE
          predicates:
            - Path=/catalog-service/**, /api/v1/products/** # âœ… ì½¤ë§ˆë¡œ ì—°ê²°
          filters:
            - name: CircuitBreaker
              args:
                name: catalogCircuitBreaker
                fallbackUri: forward:/fallback/catalog

        # (3) Order Service
        - id: order-service
          uri: lb://ORDER-SERVICE
          predicates:
            - Path=/order-service/**, /api/v1/orders/** # âœ… ì½¤ë§ˆë¡œ ì—°ê²°
          filters:
            - AuthorizationHeaderFilter
            - name: CircuitBreaker
              args:
                name: orderCircuitBreaker
                fallbackUri: forward:/fallback/order
            - name: RequestRateLimiter
              args:
                key-resolver: "#{@userKeyResolver}"
                redis-rate-limiter.replenishRate: 10
                redis-rate-limiter.burstCapacity: 20
                redis-rate-limiter.requestedTokens: 1

        # (4) Search Service
        - id: search-service
          uri: lb://SEARCH-SERVICE
          predicates:
            - Path=/search-service/**, /api/v1/search/** # âœ… ì½¤ë§ˆë¡œ ì—°ê²°

        # (5) Delivery Service
        - id: delivery-service
          uri: lb://DELIVERY-SERVICE
          predicates:
            - Path=/delivery-service/**, /api/v1/deliveries/** # âœ… ì½¤ë§ˆë¡œ ì—°ê²°
          filters:
            - AuthorizationHeaderFilter

        # (6) Batch Service
        - id: batch-service
          uri: lb://BATCH-SERVICE
          predicates:
            - Path=/batch-service/** # (ë‹¨ì¼ ê²½ë¡œëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€)

        # (7) Payment Service
        - id: payment-service
          uri: lb://PAYMENT-SERVICE
          predicates:
            - Path=/payment-service/** # (ë‹¨ì¼ ê²½ë¡œëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€)
          filters:
            - AuthorizationHeaderFilter
            - name: CircuitBreaker
              args:
                name: paymentCircuitBreaker
                fallbackUri: forward:/fallback/payment

  # 2. Redis ì„¤ì • (Rate Limitingìš©)
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}

# 3. Jasypt & Security (ì•”í˜¸í™” í‚¤)
jasypt:
  encryptor:
    bean: jasyptStringEncryptor
    algorithm: PBEWithHMACSHA512AndAES_256
    iv-generator-classname: org.jasypt.iv.RandomIvGenerator
    pool-size: 2
    string-output-type: base64

token:
  # JWT Secret Key (AES-256 Encrypted)
  secret: ENC(5gtmaAozpeoVMs1gbym2Lt6S32ztOuqnUkaGG458uuYv8DIBuvvF1KBid6L5WQweh95w6TYjgLrzxyCQ/qsOtpGWzmdOY3QY9uq7JyjieyoYRN056Y368w8O1BkSiS8Cindl6C8GNKStrUISmfrUew==)

# 4. Resilience4j (Circuit Breaker & TimeLimiter)
resilience4j:
  circuitbreaker:
    configs:
      default:
        slidingWindowType: COUNT_BASED
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        failureRateThreshold: 50
        waitDurationInOpenState: 10s
        permittedNumberOfCallsInHalfOpenState: 3
        registerHealthIndicator: true
  timelimiter:
    configs:
      default:
        timeoutDuration: 5s

# 5. Management & Actuator (í•µì‹¬ ê´€ì œ ì„¤ì •)
management:
  tracing:
    sampling:
      probability: 1.0 # Zipkin 100% ìˆ˜ì§‘
  zipkin:
    tracing:
      endpoint: http://localhost:9411/api/v2/spans
   
  # âœ… [Critical] Actuator Endpoint ë…¸ì¶œ ì„¤ì •
  endpoints:
    web:
      exposure:
        include: health, info, prometheus, gateway, circuitbreakers
   
  # âœ… [Critical] Gateway ë¼ìš°íŒ… ì •ë³´ ì—´ëŒ í™œì„±í™”
  endpoint:
    gateway:
      enabled: true

# 6. Eureka Client
# âœ… [Fix] 401 ì—ëŸ¬ í•´ê²°ì„ ìœ„í•œ ë³´ì•ˆ ê³„ì •(adam-eureka) ì£¼ì… ì™„ë£Œ
eureka:
  client:
    register-with-eureka: true
    fetch-registry: true
    service-url:
      defaultZone: http://adam-eureka:${EUREKA_SERVER_PASSWORD:adam-secret}@localhost:8761/eureka/
  instance:
    prefer-ip-address: true
    instance-id: ${spring.application.name}:${spring.application.instance_id:${random.value}}
